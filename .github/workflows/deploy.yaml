name: Deploy Scream Sheet

on:
  pull_request:
    types: [closed]
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: |
      github.event_name == 'workflow_dispatch' || (
        github.event_name == 'pull_request' && github.event.pull_request.merged == true
      )

    steps:
      - name: Calculate new release directory
        id: vars
        run: |
          RELEASE_DIR=/home/peter/Code/screamsheet_releases/release_$(date +%Y%m%d%H%M%S)
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_OUTPUT

      # 2. Checkout Code into the unique, external path
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Use the variable defined in the previous step
          path: ${{ steps.vars.outputs.RELEASE_DIR }}

      # 3. Create and Install Environment (Runs in the new path)
      - name: Create new virtual environment and Install requirements
        run: |
          PROJECT_DIR=${{ steps.vars.outputs.RELEASE_DIR }}
          
          # Create venv
          python3 -m venv $PROJECT_DIR/env
          
          # Install requirements
          $PROJECT_DIR/env/bin/python -m pip install -r $PROJECT_DIR/requirements.txt

      # 4. Configure permissions
      - name: Make screamsheet.sh executable
        run: |
          PROJECT_DIR=${{ steps.vars.outputs.RELEASE_DIR }}
          chmod +x $PROJECT_DIR/screamsheet.sh
          
      # 5. ATOMIC SWITCH: Update the live symlink
      - name: Switch Live Symlink
        run: |
          PROJECT_DIR=${{ steps.vars.outputs.RELEASE_DIR }}
          LIVE_PATH=/home/peter/Code/screamsheet_live 

          # Atomically updates the symlink to point to the new, complete directory
          ln -snf $PROJECT_DIR $LIVE_PATH

      # 6. Run deployment script (runs the script from the new live path)
      - name: Run deployment script
        run: |
          /home/peter/Code/screamsheet_live/screamsheet.sh
          
      # 7. Cleanup (Highly recommended)
      - name: Cleanup Old Releases
        run: |
          cd /home/peter/Code/screamsheet_releases
          # Keep only the last 3 releases (adjust this number as needed)
          ls -t | grep 'release_' | tail -n +4 | xargs rm -rf
