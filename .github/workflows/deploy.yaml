name: Deploy Scream Sheet

on:
  pull_request:
    types: [closed]
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    # Ensure the PR was merged
    if: github.event.pull_request.merged == true

    steps:
      - name: Calculate new release directory
        # Sets a variable for a unique, time-stamped directory
        id: vars
        run: |
          RELEASE_DIR=/home/peter/Code/screamsheet_releases/release_$(date +%Y%m%d%H%M%S)
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_OUTPUT

      # --- Deployment Preparation: Use checkout for authentication ---
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Clones into the unique directory
          path: ${{ steps.vars.outputs.RELEASE_DIR }}

      # --- Environment Setup (No more rm -rf) ---
      - name: Create and Install Environment
        run: |
          PROJECT_DIR=${{ steps.vars.outputs.RELEASE_DIR }}
          # Create venv inside the new release directory
          python3 -m venv $PROJECT_DIR/env
          $PROJECT_DIR/env/bin/python -m pip install -r $PROJECT_DIR/requirements.txt
          
      # --- Final Configuration ---
      - name: Configure and Test
        run: |
          PROJECT_DIR=${{ steps.vars.outputs.RELEASE_DIR }}
          chmod +x $PROJECT_DIR/screamsheet.sh
          # OPTIONAL: Run basic smoke test before going live
          # $PROJECT_DIR/env/bin/python $PROJECT_DIR/smoke_test.py
          
      # --- Atomic Switch (The critical step) ---
      - name: Switch Live Symlink
        run: |
          PROJECT_DIR=${{ steps.vars.outputs.RELEASE_DIR }}
          LIVE_PATH=/home/peter/Code/screamsheet_live # This is what cron should run
          
          # Atomically updates the symlink
          ln -snf $PROJECT_DIR $LIVE_PATH

      # --- Cleanup (Optional but highly recommended) ---
      - name: Cleanup Old Releases
        run: |
          cd /home/peter/Code/screamsheet_releases
          # Keep only the last 3 releases
          ls -t | grep 'release_' | tail -n +4 | xargs rm -rf
      
      - name: Run deployment script
        run: |
          /home/peter/Code/screamsheet_live/screamsheet.sh
